# ================================================
# 프로덕션 환경 Docker Compose
# AWS Lightsail 배포용
# ================================================
#
# 구성 요소:
# 1. Spring Boot 백엔드 (myauth)
# 2. Nginx (리버스 프록시 + 정적 파일 서빙) - 선택사항
#
# 데이터베이스: AWS Lightsail Database 사용 (별도 관리)
#
# ================================================

services:
  # ========================================
  # Spring Boot 백엔드
  # ========================================
  backend:
    # GitHub Container Registry에서 이미지 가져오기
    # GitHub Actions가 자동으로 빌드하고 푸시한 이미지 사용
    image: ghcr.io/icesnake72/myauth:latest

    container_name: prod-backend

    # 백엔드 포트 노출 (프론트엔드는 80 포트 사용 예정)
    ports:
      - "8080:9080"

    environment:
      # 데이터베이스 연결 (Lightsail Database 엔드포인트)
      # .env 파일에서 자동으로 로드됨
      DB_URL: ${DB_URL}
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}

      # JWT 설정 (보안을 위해 .env 파일에서 관리)
      JWT_SECRET: ${JWT_SECRET}
      JWT_ACCESS_TOKEN_EXPIRATION: ${JWT_ACCESS_TOKEN_EXPIRATION:-3600000}
      JWT_REFRESH_TOKEN_EXPIRATION: ${JWT_REFRESH_TOKEN_EXPIRATION:-604800000}

      # OAuth 카카오 설정
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      KAKAO_REDIRECT_URI: ${KAKAO_REDIRECT_URI}

      # Spring 프로파일
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-prod}

    # Lightsail Database와 통신하기 위해 호스트 네트워크 사용 안함
    # 기본 bridge 네트워크 사용
    networks:
      - prod-network

    # 로그 설정 (로그 파일 크기 제한)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    restart: unless-stopped

  # ========================================
  # Nginx (리버스 프록시 + 정적 파일) - 나중에 추가 가능
  # ========================================
  # nginx:
  #   image: nginx:alpine
  #   container_name: prod-nginx
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #   volumes:
  #     - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./nginx/conf.d:/etc/nginx/conf.d:ro
  #     - ./frontend/build:/usr/share/nginx/html:ro
  #   networks:
  #     - prod-network
  #   depends_on:
  #     - backend
  #   restart: unless-stopped

# ========================================
# 네트워크 설정
# ========================================
networks:
  prod-network:
    driver: bridge
    name: prod-network

# ================================================
# 사용 방법
# ================================================
#
# ⚠️ 주의: .env 파일은 GitHub Actions가 자동으로 생성합니다!
#          수동으로 .env 파일을 만들 필요 없습니다.
#
# 1. GitHub Actions로 자동 배포 (권장)
#    - GitHub Secrets에 환경변수 등록 (DB_URL, JWT_SECRET 등)
#    - git push origin main 실행
#    - GitHub Actions가 자동으로:
#      * Docker 이미지 빌드
#      * GHCR에 푸시
#      * Lightsail 서버에 .env 파일 생성
#      * 컨테이너 재시작
#
# 2. 수동 배포 (테스트용)
#    Lightsail 서버에서:
#    docker-compose -f docker-compose.prod.yml up -d
#
# 3. 로그 확인
#    docker-compose -f docker-compose.prod.yml logs -f backend
#
# 4. 컨테이너 재시작
#    docker-compose -f docker-compose.prod.yml restart backend
#
# 5. 중지
#    docker-compose -f docker-compose.prod.yml down
#
# ================================================
# 주요 변경 사항 (Lightsail Database 사용)
# ================================================
#
# - MySQL 컨테이너 제거: Lightsail Database 사용
# - .env 파일 자동 생성: GitHub Actions에서 관리
# - 포트 80 직접 노출: Nginx 없이 직접 접근
# - 접속 주소: http://15.165.81.224
#
# ================================================
